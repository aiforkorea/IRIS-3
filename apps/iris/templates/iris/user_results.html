{# apps/iris/templates/iris/user_results.html #}
{% extends 'iris_base.html' %}
{% block title %}
{% endblock %}
{% block iris_content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h6 class="alert alert-primary">추론 결과</h6>
        </div>
    </div>
<div class="row mb-3 align-items-end">
    <div class="col-md-9 col-12">
        <form action="#" method="GET">
<div class="row g-2 align-items-end">
    <div class="col-12 col-md-3">
        <input type="search" name="search" class="form-control"
                placeholder="예측 품종, 확인 품종 검색"
                value="{{ search_query or '' }}">
    </div>
    <div class="col-6 col-md-2">
        <select name="confirm" class="form-select" style="font-size: 1rem;">
            <option value="">확인상태</option>
            <option value="true" {% if confirm_query == 'true' %}selected{% endif %}>확인완료</option>
            <option value="false" {% if confirm_query == 'false' %}selected{% endif %}>미확인</option>
        </select>
    </div>
    <div class="col-12 col-md-6">
        <div class="row g-2 flex-md-nowrap align-items-center">
            <div class="col-12 col-md-auto">
                <select name="date_filter_type" class="form-select" style="font-size: 1rem;">
                    <option value="" {% if not date_filter_type %}selected{% endif %}>기준일자</option>
                    <option value="created_at" {% if date_filter_type == 'created_at' %}selected{% endif %}>추론일자</option>
                    <option value="confirmed_at" {% if date_filter_type == 'confirmed_at' %}selected{% endif %}>확인일자</option>
                </select>
            </div>
            <div class="col-12 col-md-4">
                <input type="date" name="start_date" class="form-control"
                        style="font-size: 1rem; width: 100%;"
                        value="{{ start_date or '' }}">
            </div>
            <div class="col-auto d-none d-md-flex justify-content-center px-0">
                <span class="fw-bold">~</span>
            </div>
            <div class="col-12 col-md-4">
                <input type="date" name="end_date" class="form-control"
                        style="font-size: 1rem; width: 100%;"
                        value="{{ end_date or '' }}">
            </div>
        </div>
    </div>
    <div class="col-12 col-md-1 d-grid">
        <button class="btn btn-primary" type="submit" style="font-size: 1rem;">검색</button>
    </div>
</div>
        </form>
    </div>
    <div class="col-md-3 col-12 mt-2 mt-md-0 d-grid d-md-block text-md-end">
        <a href="#" class="btn btn-primary user-create-btn">다운로드</a>
    </div>
</div>

        {% if results %}
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>사용자</th> {# 사용자 ID 컬럼 추가 #}
                            <th>꽃받침길이</th>
                            <th>꽃받침너비</th>
                            <th>꽃잎길이</th>
                            <th>꽃잎너비</th>
                            <th>예측품종</th>
                            <th>확인품종</th>
                            <th>추론시간</th>
                            <th>확인시간</th>
                            <th>동작</th>
                            <th>수정</th> 
                            <th>삭제</th> 
                        </tr>
                    </thead>
<tbody>
    {% for result in results %}
    <tr>
        <td>{{ result.id }}</td>
        <td>{{ result.user_id }}</td> {# 사용자 ID 값 표시 #}
        <td>{{ result.sepal_length }}</td>
        <td>{{ result.sepal_width }}</td>
        <td>{{ result.petal_length }}</td>
        <td>{{ result.petal_width }}</td>
        <td><span class="badge {% if result.predicted_class == 'setosa' %}bg-success{% elif result.predicted_class == 'versicolor' %}bg-warning text-dark{% elif result.predicted_class == 'virginica' %}bg-danger{% else %}bg-secondary{% endif %}">{{ result.predicted_class }}</span></td>
        <td>
            {% if result.confirmed_class %}
                <span class="badge {% if result.confirmed_class == 'setosa' %}bg-success{% elif result.confirmed_class == 'versicolor' %}bg-warning text-dark{% elif result.confirmed_class == 'virginica' %}bg-danger{% else %}bg-secondary{% endif %}">{{ result.confirmed_class }}</span>
            {% else %}
                미확인
            {% endif %}
        </td>
        <td>{{ result.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
        <td>
            {% if result.confirmed_at %}
                {{ result.confirmed_at.strftime('%Y-%m-%d %H:%M:%S') }}
            {% else %}
                -
            {% endif %}
        </td>
        <td>
            {% if not result.confirmed_class and (current_user.id == result.user_id or current_user.is_admin() or current_user.is_expert()) %}
                <form action="{{ url_for('iris.edit_confirmed_class', result_id=result.id) }}" method="POST" class="d-inline">
                    {{ form.csrf_token }}
                    <div class="input-group">
                        <select class="form-select form-select-sm" name="confirmed_class">
                            <option value="setosa">setosa</option>
                            <option value="versicolor">versicolor</option>
                            <option value="virginica">virginica</option>
                        </select>
                        <button type="submit" class="btn btn-sm btn-primary">확인</button>
                    </div>
                </form>
            {% else %}
                <span class="badge bg-secondary">확인 완료</span>
            {% endif %}
        </td>
        
        <td> {# 수정 컬럼 #}
            {% if result.confirmed_class and (current_user.id == result.user_id or current_user.is_admin() or current_user.is_expert()) %}
                <form action="{{ url_for('iris.edit_confirmed_class', result_id=result.id) }}" method="POST" class="d-inline">
                    {{ form.csrf_token }}
                    <div class="input-group">
                        <select class="form-select form-select-sm" name="confirmed_class">
                            <option value="setosa" {% if result.confirmed_class == 'setosa' %}selected{% endif %}>setosa</option>
                            <option value="versicolor" {% if result.confirmed_class == 'versicolor' %}selected{% endif %}>versicolor</option>
                            <option value="virginica" {% if result.confirmed_class == 'virginica' %}selected{% endif %}>virginica</option>
                        </select>
                        <button type="submit" class="btn btn-sm btn-warning">수정</button>
                    </div>
                </form>
            {% else %}
                - 
            {% endif %}
        </td>
        <td> {# 삭제 컬럼 #}
            {% if current_user.id == result.user_id or current_user.is_admin() or current_user.is_expert() %}
                <form action="{{ url_for('iris.delete_result', result_id=result.id) }}" method="POST" class="d-inline" onsubmit="return confirm('정말로 이 추론 결과를 삭제하시겠습니까?');">
                    {{ form.csrf_token }} {# CSRF 토큰 추가 #}
                    <button type="submit" class="btn btn-danger btn-sm">삭제</button>
                </form>
            {% else %}
                -
            {% endif %}
        </td>
    </tr>
    {% endfor %}
</tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info" role="alert">
                AI 추론 결과가 없습니다. <a href="{{ url_for('iris.iris_predict') }}" class="alert-link">지금 붓꽃 분류하기</a>
            </div>
        {% endif %}
    </div>
<style>
/* 모바일 (기본값) */
.user-create-btn {
    width: 100%;
}
/* Medium (md) 이상 화면 (768px 이상) */
@media (min-width: 768px) {
    .user-create-btn {
        width: auto;
    }
}
</style>
{% endblock %}