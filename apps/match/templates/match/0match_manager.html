{# apps/match/templates/match/match_manager.html #}
{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">매칭 관리 페이지</h2>
   
    <ul class="nav nav-tabs" id="matchTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="new-match-tab" data-bs-toggle="tab" data-bs-target="#new-match" type="button" role="tab" aria-controls="new-match" aria-selected="true">
                신규 매칭 ({{ unassigned_matches|length }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="manage-match-tab" data-bs-toggle="tab" data-bs-target="#manage-match" type="button" role="tab" aria-controls="manage-match" aria-selected="false">
                매칭 관리 ({{ completed_matches|length }})
            </button>
        </li>
    </ul>

    <div class="tab-content" id="matchTabsContent">
        <div class="tab-pane fade show active" id="new-match" role="tabpanel" aria-labelledby="new-match-tab">
            <div class="card my-3">
                <div class="card-header">
                    <h5 class="mb-0">신규 매칭 사용자 검색</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('match.match_manager') }}">
                        {{ new_match_form.csrf_token }}
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                {{ new_match_form.email.label(class="form-label") }}
                                {{ new_match_form.email(class="form-control") }}
                            </div>
                            <div class="col-md-3">
                                {{ new_match_form.start_date.label(class="form-label") }}
                                {{ new_match_form.start_date(class="form-control", type="date") }}
                            </div>
                            <div class="col-md-3">
                                {{ new_match_form.end_date.label(class="form-label") }}
                                {{ new_match_form.end_date(class="form-control", type="date") }}
                            </div>
                            <div class="col-md-3">
                                <button type="submit" name="search_submit" class="btn btn-primary w-100">검색</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <form method="POST" action="{{ url_for('match.create_new_match') }}">
                {{ new_match_form.csrf_token }}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">매칭 대기 사용자 목록 ({{ users_to_match|length }}명)</h5>
                    <div class="d-flex align-items-center gap-2">
                        {{ new_match_form.expert_id(class="form-select") }}
                        <button type="submit" name="assign_submit" class="btn btn-success">매칭 생성</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="checkAllUsers"></th>
                                <th>ID</th>
                                <th>이메일</th>
                                <th>사용자 타입</th>
                                <th>등록일자</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users_to_match %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="user_ids" value="{{ user.id }}" class="user-checkbox">
                                </td>
                                <td>{{ user.id }}</td>
                                <td>{{ user.email }}</td>
                                <td>{{ user.user_type.value }}</td>
                                <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center">매칭 대기 중인 사용자가 없습니다.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>
        </div>

        <div class="tab-pane fade" id="manage-match" role="tabpanel" aria-labelledby="manage-match-tab">
            <div class="card my-3">
                <div class="card-header">
                    <h5 class="mb-0">매칭 기록 검색</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('match.match_manager') }}">
                        {{ match_search_form.csrf_token }}
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                {{ match_search_form.user_id.label(class="form-label") }}
                                {{ match_search_form.user_id(class="form-control") }}
                            </div>
                            <div class="col-md-3">
                                {{ match_search_form.expert_id.label(class="form-label") }}
                                {{ match_search_form.expert_id(class="form-control") }}
                            </div>
                            <div class="col-md-3">
                                {{ match_search_form.status.label(class="form-label") }}
                                {{ match_search_form.status(class="form-select") }}
                            </div>
                            <div class="col-md-3">
                                {{ match_search_form.start_date.label(class="form-label") }}
                                {{ match_search_form.start_date(class="form-control", type="date") }}
                            </div>
                            <div class="col-md-3">
                                {{ match_search_form.end_date.label(class="form-label") }}
                                {{ match_search_form.end_date(class="form-control", type="date") }}
                            </div>
                            <div class="col-md-3">
                                <button type="submit" name="search_submit" class="btn btn-primary w-100">검색</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <form method="POST" action="{{ url_for('match.batch_update_matches') }}">
                {{ match_search_form.csrf_token }}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">전체 매칭 기록</h5>
                    <div class="d-flex align-items-center gap-2">
                        {{ match_search_form.batch_expert_id(class="form-select") }}
                        <button type="submit" name="batch_assign_submit" class="btn btn-warning">일괄 할당</button>
                        <button type="submit" name="batch_cancel_submit" class="btn btn-danger">일괄 취소</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="checkAllMatches"></th>
                                <th>매칭 ID</th>
                                <th>사용자</th>
                                <th>전문가</th>
                                <th>상태</th>
                                <th>매칭일</th>
                                <th>종료일</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for match in matches_history %}
                            <tr>
                                <td><input type="checkbox" name="match_ids" value="{{ match.id }}" class="match-checkbox"></td>
                                <td>{{ match.id }}</td>
                                <td><a href="#">{{ match.user.email }}</a></td>
                                <td><a href="#">{{ match.expert.email }}</a></td>
                                <td>{{ match.status.value }}</td>
                                <td>{{ match.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ match.closed_at.strftime('%Y-%m-%d %H:%M') if match.closed_at else 'N/A' }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="7" class="text-center">조건에 맞는 매칭 기록이 없습니다.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>

            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    {% for page_num in pagination.iter_pages() %}
                        {% if page_num %}
                            {% if pagination.page == page_num %}
                                <li class="page-item active"><a class="page-link" href="#">{{ page_num }}</a></li>
                            {% else %}
                                <li class="page-item"><a class="page-link" href="{{ url_for('match.match_manager', page=page_num) }}">{{ page_num }}</a></li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </nav>
        </div>
    </div>
</div>

<script>
    // 체크박스 전체 선택/해제 기능
    document.getElementById('checkAllUsers').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('#new-match .user-checkbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
    });
    document.getElementById('checkAllMatches').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('#manage-match .match-checkbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
    });
</script>
{% endblock %}