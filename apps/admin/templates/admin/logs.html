{# apps/admin/templates/admin/logs.html #}
{% extends "base.html" %}
{% from "_macros.html" import render_pagination %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">{{ title }}</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">대시보드</a></li>
        <li class="breadcrumb-item active">{{ title }}</li>
    </ol>

    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-search me-1"></i>
            로그 검색
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('admin.log_list') }}" class="row g-3 align-items-center">
                <div class="col-md-5">
                    <label for="search_query" class="form-label">통합 검색 (ID, 대상 ID, 로그 제목, 엔드포인트)</label>
                    <input type="text" class="form-control" id="search_query" name="search_query" placeholder="ID, 대상 ID, 로그 제목, 엔드포인트 입력" value="{{ search_params.search_query or '' }}">
                </div>
                <div class="col-md-2">
                    <label for="start_date" class="form-label">기간</label>
                    <input type="date" class="form-control" id="start_date" name="start_date" value="{{ search_params.start_date or '' }}">
                </div>
                <div class="col-auto d-flex align-items-end">
                    <span class="form-label mb-2">~</span>
                </div>
                <div class="col-md-2">
                    <label for="end_date" class="form-label">&nbsp;</label>
                    <input type="date" class="form-control" id="end_date" name="end_date" value="{{ search_params.end_date or '' }}">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">검색</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-table me-1"></i>
            로그 목록
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="datatablesSimple" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>사용자 (ID)</th>
                            <th>대상 (ID)</th>
                            <th>엔드포인트</th>
                            <th>로그 제목</th>
                            <th>내용 요약</th>
                            <th>타임스탬프</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs %}
                        <tr>
                            <td>{{ log.id }}</td>
                            <td>
                                {% if log.actor %}
                                    {{ log.actor.username }} ({{ log.user_id }})
                                {% else %}
                                    - ({{ log.user_id }})
                                {% endif %}
                            </td>
                            <td>
                                {% if log.target_user_id %}
                                    {{ log.target_user_id }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ log.endpoint }}</td>
                            <td>{{ log.log_title }}</td>
                            <td title="{{ log.log_summary }}">
                                {# 내용이 길 경우 50자까지만 표시하고 나머지는 ... 처리 #}
                                {{ log.log_summary[:50] }}{% if log.log_summary|length > 50 %}...{% endif %}
                            </td>
                            <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center">해당하는 로그가 없습니다.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-footer">
            {{ render_pagination(pagination, 'admin.log_list', filtered_args) }}
        </div>
    </div>
</div>
{% endblock %}